# 2. Proposed Technology Stack üíª

## Mejoras y Correcciones Implementadas

### Correcciones a la Documentaci√≥n Actual

1. **Inconsistencia en Stack Tecnol√≥gico**: Los documentos mencionan tanto casino/blockchain como fitness. Nos enfocamos exclusivamente en GymPal fitness.

2. **Complejidad Innecesaria Inicial**: 
   - Kafka puede ser reemplazado por Redis Pub/Sub inicialmente
   - Service mesh (Istio) es overkill para el MVP
   - Kubernetes puede diferirse hasta fase de producci√≥n

3. **Falta de Especificaciones**:
   - No hay esquema detallado de base de datos ejecutable
   - Faltan migraciones iniciales de Supabase
   - No hay ejemplos concretos de implementaci√≥n de servicios

4. **Mejoras Recomendadas**:
   - Estructura de backend modular y escalable
   - Implementar tipos compartidos para reutilizaci√≥n
   - Definir contratos de API con Zod para validaci√≥n runtime
   - Configurar testing desde d√≠a 1
   - Implementar observabilidad b√°sica (logging estructurado)

## Decisi√≥n Final

| Capa | Tecnolog√≠a | Justificaci√≥n |
|------|------------|---------------|
| **Frontend** | Next.js 14 (App Router) + Zustand | SSR, SEO, File-based routing |
| **UI Components** | shadcn/ui + Tailwind | Moderno, accesible, customizable |
| **Backend** | Hono + TypeScript | 10x m√°s r√°pido que Express, TS-first |
| **Database** | Supabase (Postgres) | BaaS completo, Auth integrado |
| **Auth** | Supabase Auth (OAuth2) | OAuth2/OIDC out-of-the-box |
| **Storage** | Supabase Storage | S3-compatible, integrado con Auth |
| **AI Platform** | Dify AI | Orchestraci√≥n LLM, prompts management |
| **Containerization** | Docker | Standard de facto |
| **Orchestration** | Kubernetes (kind local) | Requisito acad√©mico |
| **GitOps** | ArgoCD | Declarative deployments |
| **Monitoring** | Prometheus + Grafana | Metrics y dashboards |
| **Logs** | Loki + Promtail | Agregaci√≥n de logs |
| **Package Manager** | npm/yarn | Gesti√≥n de dependencias |
| **Testing** | Vitest + Supertest | Testing moderno y r√°pido |
| **Validation** | Zod | Validaci√≥n runtime type-safe |

## Frontend

- **Next.js 14** (App Router) + **TypeScript**.
- **Tailwind CSS** + **shadcn/ui** para UI moderna y accesible.
- **Auth** con OAuth2/OIDC v√≠a Supabase Auth o Auth.js.
- **Estado**: React Query/Server Actions, Zustand donde convenga.
- **SSR/ISR** para SEO y rendimiento.

## Backend

- **Node.js + TypeScript** con **Hono** para APIs REST y WebSocket.
- **Supabase** (PostgreSQL, Auth, Storage, Realtime) como backend acelerador.
- **n8n** para orquestaci√≥n de flujos (chatbots en Telegram/WhatsApp, emails, cron).
- **Dify AI** para recomendador y flujos de IA; integraci√≥n v√≠a API.
- **Proton Mail** (o SMTP compatible) para emails.

## Arquitectura Backend Simplificada

### Estructura del Proyecto Backend (Actualizada)

```
PTI-GymPalBack/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app.ts                    # Main Hono application setup
‚îÇ   ‚îú‚îÄ‚îÄ server.ts                 # Server entry point
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ core/                     # Core application infrastructure
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config/               # Configuration files
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.ts       # Supabase client configuration
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database-helpers.ts # Type-safe DB operation helpers
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ env.ts            # Environment variables with Zod
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.ts         # Pino logger configuration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ constants/            # Application constants
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api.ts            # HTTP status codes, error codes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes.ts             # Centralized route constants
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/                # Type definitions
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ database.types.ts # Supabase generated types
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/                # Utility functions
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ response.ts       # Response helpers
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ errors.ts         # Custom error classes
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ auth.ts           # Auth utilities
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ middleware/               # HTTP middleware
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.ts              # Authentication middleware
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ error.ts             # Global error handler
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logging.ts           # Request logging with Pino
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validation.ts        # Zod validation middleware
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rate-limit.ts         # Rate limiting middleware
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ modules/                  # Business domain modules
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/                # Authentication module
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes.ts         # Route definitions with @openapi
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers.ts       # HTTP request handlers
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ service.ts        # Business logic
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas.ts       # Zod validation schemas
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types.ts         # TypeScript type definitions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users/               # User management module
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ workouts/            # Workout management module
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ exercises/           # Exercise library module
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ social/              # Social features module
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard/           # Dashboard analytics module
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ personal/            # Personal data module
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings/            # User settings module
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ plugins/                  # Hono plugins
‚îÇ       ‚îú‚îÄ‚îÄ health.ts            # Health check plugin
‚îÇ       ‚îî‚îÄ‚îÄ openapi.ts           # OpenAPI documentation plugin
‚îÇ
‚îú‚îÄ‚îÄ supabase/                     # Database configuration
‚îÇ   ‚îî‚îÄ‚îÄ migrations/               # Database migrations
‚îÇ       ‚îú‚îÄ‚îÄ 001_schema.sql        # Database schema
‚îÇ       ‚îú‚îÄ‚îÄ 002_rls_policies.sql  # Row Level Security
‚îÇ       ‚îú‚îÄ‚îÄ 003_seed_data.sql    # Seed data (optional)
‚îÇ       ‚îî‚îÄ‚îÄ 004_triggers.sql     # Triggers and database functions
‚îÇ
‚îú‚îÄ‚îÄ dist/                         # Compiled TypeScript output
‚îú‚îÄ‚îÄ Dockerfile                    # Production Docker image
‚îú‚îÄ‚îÄ docker-compose.yml            # Development environment
‚îú‚îÄ‚îÄ package.json                  # Dependencies
‚îú‚îÄ‚îÄ tsconfig.json                 # TypeScript configuration
‚îî‚îÄ‚îÄ openapi.json                  # OpenAPI specification
```

### Configuraci√≥n Base

- **Runtime**: Node.js 20 LTS
- **Framework**: Hono (ligero y r√°pido)
- **TypeScript**: 5.3+ con strict mode
- **ES Modules**: Configuraci√≥n moderna con `"type": "module"`
- **OpenAPI 3.1**: Documentaci√≥n autom√°tica con Scalar
- **Validaci√≥n**: Zod para validaci√≥n robusta de datos

### Arquitectura Actual Implementada

**üèóÔ∏è Arquitectura Modular Moderna:**
- **Estructura modular**: Cada m√≥dulo contiene routes, handlers, service, schemas, types
- **Core infrastructure**: Configuraci√≥n centralizada (database, env, logger)
- **Middleware global**: Auth, error handling, logging, validation, rate limiting
- **Plugins**: Health check y OpenAPI documentation integrados
- **Type-safe operations**: Database helpers con TypeScript generics
- **Self-service features**: Account deletion sin service role key (v√≠a database function)
- **OpenAPI integrado**: Documentaci√≥n autom√°tica con @openapi comments
- **Logging estructurado**: Pino para logging JSON estructurado

**üìä Funcionalidades Avanzadas:**
- **Informaci√≥n personal detallada** (edad, peso, altura, BMI, grasa corporal)
- **Objetivos de fitness** (nivel de experiencia, metas, frecuencia)
- **Preferencias diet√©ticas** (restricciones, alergias, objetivos nutricionales)
- **Rutinas personalizadas** (creaci√≥n, b√∫squeda, compartici√≥n)
- **Posts sociales avanzados** (tipos, hashtags, trending, b√∫squeda)
- **Dashboard anal√≠tico** (estad√≠sticas, actividad reciente)
- **Configuraci√≥n de usuario** (notificaciones, privacidad, preferencias)

**üîß Herramientas de Desarrollo:**
- **Supabase CLI**: Migraciones y tipos generados autom√°ticamente
- **Vitest**: Testing completo con cobertura
- **ESLint + Prettier**: Linting y formateo autom√°tico
- **Scripts OpenAPI**: Generaci√≥n autom√°tica de documentaci√≥n
- **Documentaci√≥n Interactiva**: Scalar API Reference integrada

## Diagrama de Arquitectura Tecnol√≥gica

```mermaid
graph TB
  subgraph "Frontend Layer"
    NEXT[Next.js 14 App Router]
    TAILWIND[Tailwind CSS + shadcn/ui]
    ZUSTAND[Zustand State Management]
    REACT_QUERY[React Query]
  end
  
  subgraph "Backend Layer"
    HONO[Hono Framework]
    TYPESCRIPT[TypeScript 5.3+]
    ZOD[Zod Validation]
    VITEST[Vitest Testing]
  end
  
  subgraph "Database Layer"
    SUPABASE[Supabase PostgreSQL]
    RLS[Row Level Security]
    MIGRATIONS[Database Migrations]
  end
  
  subgraph "AI & External Services"
    DIFY[Dify AI Platform]
    N8N[n8n Workflow Engine]
    PROTON[Proton Mail]
  end
  
  subgraph "Infrastructure"
    DOCKER[Docker Containers]
    K8S[Kubernetes]
    ARGOCD[ArgoCD GitOps]
  end
  
  subgraph "Monitoring"
    PROMETHEUS[Prometheus]
    GRAFANA[Grafana]
    LOKI[Loki + Promtail]
  end
  
  NEXT --> HONO
  TAILWIND --> NEXT
  ZUSTAND --> NEXT
  REACT_QUERY --> NEXT
  
  HONO --> SUPABASE
  HONO --> DIFY
  HONO --> N8N
  HONO --> PROTON
  
  SUPABASE --> RLS
  SUPABASE --> MIGRATIONS
  
  HONO --> DOCKER
  DOCKER --> K8S
  K8S --> ARGOCD
  
  HONO --> PROMETHEUS
  PROMETHEUS --> GRAFANA
  HONO --> LOKI
```

## Comparaci√≥n de Tecnolog√≠as

### Framework Backend: Hono vs Express

```mermaid
graph LR
  subgraph "Hono Advantages"
    H1[10x m√°s r√°pido]
    H2[TypeScript-first]
    H3[OpenAPI integrado]
    H4[Middleware moderno]
    H5[WebSocket nativo]
  end
  
  subgraph "Express Advantages"
    E1[Ecosistema maduro]
    E2[Documentaci√≥n extensa]
    E3[Comunidad grande]
    E4[Plugins abundantes]
  end
  
  H1 --> DECISION[Decisi√≥n: Hono]
  H2 --> DECISION
  H3 --> DECISION
  H4 --> DECISION
  H5 --> DECISION
```

### Base de Datos: Supabase vs Prisma + PostgreSQL

```mermaid
graph TB
  subgraph "Supabase Benefits"
    S1[Auth integrado]
    S2[Real-time subscriptions]
    S3[Storage integrado]
    S4[RLS autom√°tico]
    S5[API REST autom√°tica]
    S6[Dashboard admin]
  end
  
  subgraph "Prisma Benefits"
    P1[Type safety completo]
    P2[Query builder potente]
    P3[Migraciones avanzadas]
    P4[Multi-database support]
  end
  
  S1 --> CHOICE[Elegido: Supabase]
  S2 --> CHOICE
  S3 --> CHOICE
  S4 --> CHOICE
  S5 --> CHOICE
  S6 --> CHOICE
```

